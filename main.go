package main

import (
	"strconv"
	"strings"

	"github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm"
	"github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm/types"
)

type httpContext struct {
	proxywasm.DefaultHttpContext
	contextID uint32
}

var counter proxywasm.MetricCounter

func newHttpContext(rootContextID, contextID uint32) proxywasm.HttpContext {
	return &httpContext{contextID: contextID}
}

func (ctx *httpContext) OnHttpRequestHeaders(numHeaders int, endOfStream bool) types.Action {
	proxywasm.LogInfo("accessed to OnHttpRequestHeaders")
	hs, err := proxywasm.GetHttpRequestHeaders()
	if err != nil {
		proxywasm.LogCriticalf("failed to get request headers: %v", err)
		return types.ActionContinue
	}
	for _, h := range hs {
		proxywasm.LogInfof("request header received key:%s\tval:%s", h[0], h[1])
		if strings.Contains(h[0], "method") && strings.EqualFold(h[1], "get") {
			proxywasm.LogInfof("get method detected key:%s\tval:%s", h[0], h[1])
			proxywasm.SendHttpResponse(418, [][2]string{
				{"powered-by", "proxy-wasm-go-sdk!!"},
				{"context-id", strconv.Itoa(int(ctx.contextID))},
			}, getWild)
			return types.ActionContinue
		}
	}
	proxywasm.LogInfo("finished to execute OnHttpRequestHeaders function")
	return types.ActionContinue
}

func main() {
	proxywasm.SetNewHttpContext(newHttpContext)
}

const getWild = `          _____                    _____                    _____                    _____                            _____                    _____                _____                            _____                    _____                    _____            _____
         /\    \                  /\    \                  /\    \                  /\    \                          /\    \                  /\    \              /\    \                          /\    \                  /\    \                  /\    \          /\    \
        /::\____\                /::\    \                /::\    \                /::\    \                        /::\    \                /::\    \            /::\    \                        /::\____\                /::\    \                /::\____\        /::\    \
       /:::/    /               /::::\    \              /::::\    \               \:::\    \                      /::::\    \              /::::\    \           \:::\    \                      /:::/    /                \:::\    \              /:::/    /       /::::\    \
      /:::/   _/___            /::::::\    \            /::::::\    \               \:::\    \                    /::::::\    \            /::::::\    \           \:::\    \                    /:::/   _/___               \:::\    \            /:::/    /       /::::::\    \
     /:::/   /\    \          /:::/\:::\    \          /:::/\:::\    \               \:::\    \                  /:::/\:::\    \          /:::/\:::\    \           \:::\    \                  /:::/   /\    \               \:::\    \          /:::/    /       /:::/\:::\    \
    /:::/   /::\____\        /:::/__\:::\    \        /:::/__\:::\    \               \:::\    \                /:::/  \:::\    \        /:::/__\:::\    \           \:::\    \                /:::/   /::\____\               \:::\    \        /:::/    /       /:::/  \:::\    \
   /:::/   /:::/    /       /::::\   \:::\    \       \:::\   \:::\    \              /::::\    \              /:::/    \:::\    \      /::::\   \:::\    \          /::::\    \              /:::/   /:::/    /               /::::\    \      /:::/    /       /:::/    \:::\    \
  /:::/   /:::/   _/___    /::::::\   \:::\    \    ___\:::\   \:::\    \    ____    /::::::\    \            /:::/    / \:::\    \    /::::::\   \:::\    \        /::::::\    \            /:::/   /:::/   _/___    ____    /::::::\    \    /:::/    /       /:::/    / \:::\    \
 /:::/___/:::/   /\    \  /:::/\:::\   \:::\    \  /\   \:::\   \:::\    \  /\   \  /:::/\:::\    \          /:::/    /   \:::\ ___\  /:::/\:::\   \:::\    \      /:::/\:::\    \          /:::/___/:::/   /\    \  /\   \  /:::/\:::\    \  /:::/    /       /:::/    /   \:::\ ___\
|:::|   /:::/   /::\____\/:::/  \:::\   \:::\____\/::\   \:::\   \:::\____\/::\   \/:::/  \:::\____\        /:::/____/  ___\:::|    |/:::/__\:::\   \:::\____\    /:::/  \:::\____\        |:::|   /:::/   /::\____\/::\   \/:::/  \:::\____\/:::/____/       /:::/____/     \:::|    |
|:::|__/:::/   /:::/    /\::/    \:::\  /:::/    /\:::\   \:::\   \::/    /\:::\  /:::/    \::/    /        \:::\    \ /\  /:::|____|\:::\   \:::\   \::/    /   /:::/    \::/    /        |:::|__/:::/   /:::/    /\:::\  /:::/    \::/    /\:::\    \       \:::\    \     /:::|____|
 \:::\/:::/   /:::/    /  \/____/ \:::\/:::/    /  \:::\   \:::\   \/____/  \:::\/:::/    / \/____/          \:::\    /::\ \::/    /  \:::\   \:::\   \/____/   /:::/    / \/____/          \:::\/:::/   /:::/    /  \:::\/:::/    / \/____/  \:::\    \       \:::\    \   /:::/    /
  \::::::/   /:::/    /            \::::::/    /    \:::\   \:::\    \       \::::::/    /                    \:::\   \:::\ \/____/    \:::\   \:::\    \      /:::/    /                    \::::::/   /:::/    /    \::::::/    /            \:::\    \       \:::\    \ /:::/    /
   \::::/___/:::/    /              \::::/    /      \:::\   \:::\____\       \::::/____/                      \:::\   \:::\____\       \:::\   \:::\____\    /:::/    /                      \::::/___/:::/    /      \::::/____/              \:::\    \       \:::\    /:::/    /
    \:::\__/:::/    /               /:::/    /        \:::\  /:::/    /        \:::\    \                       \:::\  /:::/    /        \:::\   \::/    /    \::/    /                        \:::\__/:::/    /        \:::\    \               \:::\    \       \:::\  /:::/    /
     \::::::::/    /               /:::/    /          \:::\/:::/    /          \:::\    \                       \:::\/:::/    /          \:::\   \/____/      \/____/                          \::::::::/    /          \:::\    \               \:::\    \       \:::\/:::/    /
      \::::::/    /               /:::/    /            \::::::/    /            \:::\    \                       \::::::/    /            \:::\    \                                            \::::::/    /            \:::\    \               \:::\    \       \::::::/    /
       \::::/    /               /:::/    /              \::::/    /              \:::\____\                       \::::/    /              \:::\____\                                            \::::/    /              \:::\____\               \:::\____\       \::::/    /
        \::/____/                \::/    /                \::/    /                \::/    /                        \::/____/                \::/    /                                             \::/____/                \::/    /                \::/    /        \::/____/
         ~~                       \/____/                  \/____/                  \/____/                                                   \/____/                                               ~~                       \/____/                  \/____/          ~~
`
